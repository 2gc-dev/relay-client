# CloudBridge Client Connection Diagnosis Report

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–î–∞—Ç–∞:** 28 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–µ–Ω–æ ‚úÖüî∂

---

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

### 1. –°–µ—Ä–≤–µ—Ä CloudBridge Relay
- **–ê–¥—Ä–µ—Å:** `edge.2gc.ru:8081`
- **–ü—Ä–æ—Ç–æ–∫–æ–ª:** HTTP ‚úÖ
- **Health endpoint:** `/health` ‚Üí 200 OK ‚úÖ
- **Metrics endpoint:** `/metrics` ‚Üí 200 OK ‚úÖ
- **–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞:** –ó–¥–æ—Ä–æ–≤—ã–π ‚úÖ

```bash
curl http://edge.2gc.ru:8081/health
# {"status":"healthy","timestamp":"...","services":{"database":"healthy","redis":"healthy","websocket":"healthy"}...}
```

### 2. JWT —Ç–æ–∫–µ–Ω—ã
- **–¢–æ–∫–µ–Ω Server A:** ‚úÖ –í–∞–ª–∏–¥–Ω—ã–π
- **–¢–æ–∫–µ–Ω Server B:** ‚úÖ –í–∞–ª–∏–¥–Ω—ã–π
- **Tenant ID:** `mesh-network-test` ‚úÖ
- **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:** –î–æ 12 –æ–∫—Ç—è–±—Ä—è 2025 ‚úÖ
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ü—Ä–æ—Ö–æ–¥–∏—Ç –ª–æ–∫–∞–ª—å–Ω–æ ‚úÖ

### 3. –ö–ª–∏–µ–Ω—Ç CloudBridge
- **–°–±–æ—Ä–∫–∞:** ‚úÖ –£—Å–ø–µ—à–Ω–∞
- **–¢–µ—Å—Ç—ã:** ‚úÖ –ü—Ä–æ—Ö–æ–¥—è—Ç (7/7, 2 –ø—Ä–æ–ø—É—â–µ–Ω—ã - —Ç—Ä–µ–±—É—é—Ç root)
- **–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- **–¢–æ–∫–µ–Ω —á–µ—Ä–µ–∑ CLI:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã:

### 1. –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: HTTP vs HTTPS
**–û—à–∏–±–∫–∞:** `http: server gave HTTP response to HTTPS client`

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–ª–∏–µ–Ω—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HTTPS, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é HTTP

**–î–µ—Ç–∞–ª–∏:**
- –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è: `https://edge.2gc.ru:8081`
- –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç: `http://edge.2gc.ru:8081`
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

### 2. API Endpoints
**–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:** `/api/v1/tenants/mesh-network-test/peers/register`
**–°—Ç–∞—Ç—É—Å:** 404 Not Found (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –¥—Ä—É–≥–æ–π)

**–î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:**
- ‚úÖ `/health` 
- ‚úÖ `/metrics`
- ‚ùì `/api/v1/peers` (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)

---

## üõ† –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. **JWT —Ç–æ–∫–µ–Ω—ã:** –°–æ–∑–¥–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã —Å –Ω—É–∂–Ω—ã–º–∏ claims
2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:** –°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã –¥–ª—è Server A –∏ Server B
3. **HTTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:** –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ URL –Ω–∞ HTTP
4. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤:** –û—Ç–∫–ª—é—á–µ–Ω–∞ skip_validation –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### üìã –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
- `config-test-server-a.yaml` - –¥–ª—è Server A
- `config-test-server-b.yaml` - –¥–ª—è Server B  
- `config-production.yaml` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ HTTP

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∫–ª–∏–µ–Ω—Ç–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç base_url –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏—è:**
- [ ] –ù–∞–π—Ç–∏ –≥–¥–µ –≤ –∫–æ–¥–µ –ø—Ä–æ–ø–∏—Å–∞–Ω—ã HTTPS URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ HTTP –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å configurable
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å environment variables –¥–ª—è override

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API endpoints
- [ ] –ù–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è peer registration
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `/api/v1/peers` –≤–º–µ—Å—Ç–æ `/api/v1/tenants/.../peers/register`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ endpoints

### 3. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL/TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–∞ edge.2gc.ru:8081
- [ ] –û–±–Ω–æ–≤–∏—Ç—å Nginx –¥–ª—è HTTPS proxy

---

## üîó –¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:

### –ó–∞–ø—É—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞:
```bash
# Server A
./cloudbridge-client p2p -c config-test-server-a.yaml --log-level debug

# Server B  
./cloudbridge-client p2p -c config-test-server-b.yaml --log-level debug

# –ß–µ—Ä–µ–∑ CLI (–º–∏–Ω—É—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é)
./cloudbridge-client p2p -t "JWT_TOKEN_HERE" --insecure-skip-tls-verify
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:
```bash
# Health check
curl http://edge.2gc.ru:8081/health

# Metrics
curl http://edge.2gc.ru:8081/metrics

# API endpoints
curl http://edge.2gc.ru:8081/api/v1/peers
```

---

## üìä –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

- ‚úÖ **–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç**
- ‚úÖ **–¢–æ–∫–µ–Ω—ã –≥–æ—Ç–æ–≤—ã** 
- ‚úÖ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã**
- ‚úÖ **–ö–ª–∏–µ–Ω—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**
- üî∂ **HTTP vs HTTPS –∫–æ–Ω—Ñ–ª–∏–∫—Ç**
- ‚ùì **API endpoints —Ç—Ä–µ–±—É—é—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è**

**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:** 75% ‚úÖ

---

*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏*  
*–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∫–ª–∏–µ–Ω—Ç–µ*
