#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ P2P –∫–∞–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ relay —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç iperf3 –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

echo "üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ P2P –∫–∞–Ω–∞–ª–∞ —á–µ—Ä–µ–∑ relay —Å–µ—Ä–≤–µ—Ä"
echo "=================================================="

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
RELAY_HOST="edge.2gc.ru"
RELAY_PORT="9090"  # QUIC –ø–æ—Ä—Ç
LOCAL_IP="192.168.1.119"  # IP –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
REMOTE_IP="212.233.79.160"  # IP —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

echo "üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
echo "  Relay —Å–µ—Ä–≤–µ—Ä: $RELAY_HOST:$RELAY_PORT"
echo "  –õ–æ–∫–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞: $LOCAL_IP"
echo "  –£–¥–∞–ª–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä: $REMOTE_IP"
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è UDP
test_udp_speed() {
    echo "üîµ –¢–µ—Å—Ç 1: UDP —Å–∫–æ—Ä–æ—Å—Ç—å (—á–µ—Ä–µ–∑ relay)"
    echo "----------------------------------------"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º iperf3 —Å–µ—Ä–≤–µ—Ä –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ
    echo "–ó–∞–ø—É—Å–∫–∞–µ–º iperf3 —Å–µ—Ä–≤–µ—Ä –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ..."
    ssh -F ~/.ssh/config zabbix-server "iperf3 -s -p 5201 -D" 2>/dev/null
    
    sleep 2
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º UDP —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –ø–∞–∫–µ—Ç–æ–≤
    echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º UDP —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ –ø–∞–∫–µ—Ç–æ–≤..."
    
    for packet_size in 1470 1024 512 256; do
        echo "  üì¶ –†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞: $packet_size –±–∞–π—Ç"
        iperf3 -c $REMOTE_IP -p 5201 -u -l $packet_size -t 10 -b 10M 2>/dev/null | grep -E "(Mbits/sec|KBytes/sec|lost)"
    done
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
    ssh -F ~/.ssh/config zabbix-server "pkill iperf3" 2>/dev/null
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è TCP
test_tcp_speed() {
    echo "üü¢ –¢–µ—Å—Ç 2: TCP —Å–∫–æ—Ä–æ—Å—Ç—å (—á–µ—Ä–µ–∑ relay)"
    echo "----------------------------------------"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º iperf3 —Å–µ—Ä–≤–µ—Ä –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ
    echo "–ó–∞–ø—É—Å–∫–∞–µ–º iperf3 —Å–µ—Ä–≤–µ—Ä –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ..."
    ssh -F ~/.ssh/config zabbix-server "iperf3 -s -p 5201 -D" 2>/dev/null
    
    sleep 2
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º TCP
    echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º TCP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ..."
    iperf3 -c $REMOTE_IP -p 5201 -t 30 2>/dev/null | grep -E "(Mbits/sec|KBytes/sec|retr)"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
    ssh -F ~/.ssh/config zabbix-server "pkill iperf3" 2>/dev/null
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ relay —Å–µ—Ä–≤–µ—Ä –Ω–∞–ø—Ä—è–º—É—é
test_relay_direct() {
    echo "üü° –¢–µ—Å—Ç 3: –ü—Ä—è–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ relay"
    echo "----------------------------------------"
    
    echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å relay —Å–µ—Ä–≤–µ—Ä–∞..."
    nc -u -w 3 $RELAY_HOST $RELAY_PORT < /dev/null 2>/dev/null && echo "‚úÖ Relay –¥–æ—Å—Ç—É–ø–µ–Ω" || echo "‚ùå Relay –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    
    echo "–¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ relay..."
    ping -c 3 $RELAY_HOST 2>/dev/null | grep "round-trip"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è P2P —Ç—É–Ω–Ω–µ–ª—è (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
test_p2p_tunnel() {
    echo "üü£ –¢–µ—Å—Ç 4: P2P —Ç—É–Ω–Ω–µ–ª—å (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)"
    echo "----------------------------------------"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—É–Ω–Ω–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
    echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—É–Ω–Ω–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ..."
    ssh -F ~/.ssh/config zabbix-server "ip addr show | grep -A 2 '10\.' | grep inet"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—É–Ω–Ω–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
    echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—É–Ω–Ω–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ..."
    ifconfig | grep -A 2 "inet 10\." || echo "–¢—É–Ω–Ω–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    echo "–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
    echo
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å iperf3
    if ! command -v iperf3 &> /dev/null; then
        echo "‚ùå iperf3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ"
        exit 1
    fi
    
    if ! ssh -F ~/.ssh/config zabbix-server "command -v iperf3" &> /dev/null; then
        echo "‚ùå iperf3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ"
        exit 1
    fi
    
    echo "‚úÖ iperf3 –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –æ–±–µ–∏—Ö –º–∞—à–∏–Ω–∞—Ö"
    echo
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    test_relay_direct
    test_p2p_tunnel
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å (–µ—Å–ª–∏ –ø—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ)
    echo "–ü–æ–ø—ã—Ç–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏..."
    if ping -c 1 -W 3 $REMOTE_IP &> /dev/null; then
        test_tcp_speed
        test_udp_speed
    else
        echo "‚ö†Ô∏è  –ü—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, —Ç–µ—Å—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ relay..."
        echo "–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è P2P –∫–∞–Ω–∞–ª–∞ –Ω—É–∂–Ω–æ –¥–æ–∂–¥–∞—Ç—å—Å—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—É–Ω–Ω–µ–ª—è"
    fi
    
    echo "\nüß™ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: E2E QUIC —Ç–µ—Å—Ç (9091)"
    echo "----------------------------------------"
    # 1) –ü–æ–¥–Ω–∏–º–∞–µ–º –ø—Ä–∏–µ–º–Ω–∏–∫ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ
    ssh -F ~/.ssh/config zabbix-server '
      set -e
      cd ~/cloudbridge-test || exit 1
      pkill -f quic-tester || true
      chmod +x ./quic-tester || true
      nohup ./quic-tester --mode=recv --token="$(cat token.txt)" --host=edge.2gc.ru --port=9091 --timeout=25s > recv.log 2>&1 &
      echo $! > recv.pid
      sleep 2
      echo -n "REMOTE PID: "; cat recv.pid
      tail -n 5 recv.log || true
    '

    # 2) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ A -> B
    if [ -x "./bin/quic-tester" ]; then
      TOKEN1=$(cat token-client1.txt 2>/dev/null)
      if [ -n "$TOKEN1" ]; then
        echo "\n–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ quic-tester (–ª–æ–∫–∞–ª—å–Ω–æ -> —É–¥–∞–ª–µ–Ω–Ω—ã–π peer)..."
        ./bin/quic-tester --mode=send --token="$TOKEN1" --host=edge.2gc.ru --port=9091 --to=peer_server-1758248075566 --msg="hello-from-A" --timeout=25s || true
      else
        echo "‚ö†Ô∏è  –ù–µ –Ω–∞–π–¥–µ–Ω token-client1.txt –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏"
      fi
    else
      echo "‚ö†Ô∏è  quic-tester –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ./bin/quic-tester ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É"
    fi

    # 3) –ß–∏—Ç–∞–µ–º –ª–æ–≥–∏ –ø—Ä–∏–µ–º–Ω–∏–∫–∞
    echo "\n–õ–æ–≥–∏ –ø—Ä–∏–µ–º–Ω–∏–∫–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ:"
    ssh -F ~/.ssh/config zabbix-server 'cd ~/cloudbridge-test && tail -n 50 recv.log || true'

    echo "\nüèÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
main "$@"
