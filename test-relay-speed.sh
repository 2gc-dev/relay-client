#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ relay —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç UDP –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

echo "üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ relay —Å–µ—Ä–≤–µ—Ä"
echo "============================================="

RELAY_HOST="edge.2gc.ru"
RELAY_PORT="9090"  # QUIC –ø–æ—Ä—Ç
TEST_DURATION=10
PACKET_SIZES=(1470 1024 512 256 128)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è UDP —á–µ—Ä–µ–∑ relay
test_udp_via_relay() {
    echo "üîµ –¢–µ—Å—Ç UDP —á–µ—Ä–µ–∑ relay —Å–µ—Ä–≤–µ—Ä"
    echo "------------------------------"
    
    for size in "${PACKET_SIZES[@]}"; do
        echo "üì¶ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–∞–∫–µ—Ç—ã —Ä–∞–∑–º–µ—Ä–æ–º $size –±–∞–π—Ç..."
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º UDP –ø–∞–∫–µ—Ç—ã –Ω–∞ relay —Å–µ—Ä–≤–µ—Ä
        echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º $TEST_DURATION —Å–µ–∫—É–Ω–¥ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ relay..."
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º nc –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        (
            for i in $(seq 1 $((TEST_DURATION * 10))); do
                dd if=/dev/zero bs=$size count=1 2>/dev/null
                sleep 0.1
            done
        ) | nc -u -w 1 $RELAY_HOST $RELAY_PORT 2>/dev/null &
        
        local nc_pid=$!
        sleep $TEST_DURATION
        kill $nc_pid 2>/dev/null
        
        echo "‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ $size –±–∞–π—Ç"
        echo
    done
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏
test_latency() {
    echo "üü° –¢–µ—Å—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–æ relay —Å–µ—Ä–≤–µ—Ä–∞"
    echo "---------------------------------"
    
    echo "–ò–∑–º–µ—Ä—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ relay —Å–µ—Ä–≤–µ—Ä–∞..."
    ping -c 10 $RELAY_HOST 2>/dev/null | grep "round-trip" || echo "Ping –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–æ–≤
test_port_availability() {
    echo "üü¢ –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–æ–≤ relay —Å–µ—Ä–≤–µ—Ä–∞"
    echo "----------------------------------------"
    
    local ports=(8080 8082 8083 9090 9092 19302 8443 9444)
    
    for port in "${ports[@]}"; do
        echo -n "–ü–æ—Ä—Ç $port: "
        if nc -z -w 3 $RELAY_HOST $port 2>/dev/null; then
            echo "‚úÖ –û—Ç–∫—Ä—ã—Ç"
        else
            echo "‚ùå –ó–∞–∫—Ä—ã—Ç"
        fi
    done
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è QUIC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
test_quic_connection() {
    echo "üü£ –¢–µ—Å—Ç QUIC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
    echo "-----------------------"
    
    echo "–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å QUIC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å relay..."
    
    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ QUIC –ø–æ—Ä—Ç–∞
    if nc -u -z -w 3 $RELAY_HOST $RELAY_PORT 2>/dev/null; then
        echo "‚úÖ QUIC –ø–æ—Ä—Ç $RELAY_PORT –¥–æ—Å—Ç—É–ø–µ–Ω"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ..."
        echo "TEST_DATA_$(date +%s)" | nc -u -w 1 $RELAY_HOST $RELAY_PORT 2>/dev/null
        echo "‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
    else
        echo "‚ùå QUIC –ø–æ—Ä—Ç $RELAY_PORT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    fi
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞
monitor_network_traffic() {
    echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞"
    echo "------------------------------"
    
    echo "–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ relay —Å–µ—Ä–≤–µ—Ä—É:"
    netstat -an | grep "$RELAY_HOST" | head -5
    echo
    
    echo "UDP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:"
    netstat -an | grep "udp.*$RELAY_HOST" | head -3
    echo
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    echo "–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ relay —Å–µ—Ä–≤–µ—Ä..."
    echo
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å relay —Å–µ—Ä–≤–µ—Ä–∞
    if ! ping -c 1 -W 3 $RELAY_HOST &> /dev/null; then
        echo "‚ùå Relay —Å–µ—Ä–≤–µ—Ä $RELAY_HOST –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        exit 1
    fi
    
    echo "‚úÖ Relay —Å–µ—Ä–≤–µ—Ä $RELAY_HOST –¥–æ—Å—Ç—É–ø–µ–Ω"
    echo
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    test_port_availability
    test_latency
    test_quic_connection
    monitor_network_traffic
    
    echo "‚ö†Ô∏è  –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è P2P –∫–∞–Ω–∞–ª–∞ –Ω—É–∂–Ω–æ:"
    echo "   1. –î–æ–∂–¥–∞—Ç—å—Å—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—É–Ω–Ω–µ–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤"
    echo "   2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ —Ç—É–Ω–Ω–µ–ª—è"
    echo "   3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ —Ç—É–Ω–Ω–µ–ª—å"
    echo
    
    echo "üèÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
main "$@"
