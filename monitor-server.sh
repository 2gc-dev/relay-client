#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ relay —Å–µ—Ä–≤–µ—Ä–∞
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Ä—Ç 8083 –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç, –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω

echo "üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Relay —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8083"
echo "======================================================"
echo "–í—Ä–µ–º—è: $(date)"
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
check_server() {
    local url=$1
    local name=$2
    
    if curl -s --connect-timeout 5 "$url" > /dev/null 2>&1; then
        echo "‚úÖ $name –¥–æ—Å—Ç—É–ø–µ–Ω"
        return 0
    else
        echo "‚ùå $name –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        return 1
    fi
}

# –ñ–¥–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
echo "‚è≥ –ñ–¥–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Relay —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8083..."
while ! check_server "http://edge.2gc.ru:8083/health" "Relay Server (8083)"; do
    echo "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∂–¥–µ–º 10 —Å–µ–∫—É–Ω–¥..."
    sleep 10
done

echo
echo "üéâ Relay —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω! –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ—Ç–∞–ª–∏..."
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ Health Endpoint:"
curl -s "http://edge.2gc.ru:8083/health" | python3 -m json.tool 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å JSON"

echo
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç..."
echo

# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç
./cloudbridge-client p2p --config config-test-quic.yaml --token "$(cat token1-clean.txt)" --log-level debug

